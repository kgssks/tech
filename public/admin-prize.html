<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경품 배부 관리 - AI 기술테크포럼 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .admin-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--kb-background) 0%, #f0f0f0 100%);
        }
        
        .admin-card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--kb-shadow);
            background: white;
        }
        
        .admin-header {
            background: linear-gradient(135deg, var(--kb-gray) 0%, var(--kb-dark-gray) 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 2rem;
            text-align: center;
        }
        
        .qr-reader-container {
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 1rem 0;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }
        
        .qr-reader-container.active {
            border-color: var(--kb-yellow-positive);
            background: #fff8e1;
        }
        
        .qr-reader-container.success {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .qr-reader-container.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .camera-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #qr-reader {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 15px;
        }
        
        .qr-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid var(--kb-yellow-positive);
            border-radius: 10px;
            pointer-events: none;
        }
        
        .qr-overlay::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 2px solid rgba(255, 188, 0, 0.3);
            border-radius: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .user-info {
            background: var(--kb-background);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .btn-admin {
            background: linear-gradient(135deg, var(--kb-gray) 0%, var(--kb-dark-gray) 100%);
            border: none;
            color: white;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 25px;
            box-shadow: 0 5px 15px rgba(96, 88, 76, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(96, 88, 76, 0.4);
            color: white;
        }
        
        .btn-admin:disabled {
            background: #ccc;
            box-shadow: none;
            transform: none;
        }
        
        .btn-success-admin {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success-admin:hover {
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        .status-message {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .scanning-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 1rem 0;
        }
        
        .scanning-dot {
            width: 10px;
            height: 10px;
            background: var(--kb-yellow-positive);
            border-radius: 50%;
            animation: scanning 1.5s infinite;
        }
        
        .scanning-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .scanning-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes scanning {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- 네비게이션 -->
        <nav class="navbar navbar-expand-lg navbar-dark" style="background: var(--kb-gray);">
            <div class="container">
                <a class="navbar-brand fw-bold" href="/app/admin/">
                    <i class="fas fa-cog me-2"></i>관리자 패널
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/app/admin/">
                        <i class="fas fa-chart-bar me-1"></i>대시보드
                    </a>
                    <button onclick="logout()" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i>로그아웃
                    </button>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card admin-card">
                        <div class="admin-header">
                            <h2 class="mb-3">
                                <i class="fas fa-qrcode me-2"></i>경품 배부 관리
                            </h2>
                            <p class="mb-0">참가자의 경품 QR 코드를 스캔하여 교환을 처리하세요</p>
                        </div>
                        
                        <div class="card-body p-4">
                            <!-- QR 리더 섹션 -->
                            <div id="qrReaderSection" class="qr-reader-container">
                                <h5 class="mb-3">
                                    <i class="fas fa-camera me-2"></i>QR 코드 스캔
                                </h5>
                                
                                <div class="camera-container">
                                    <div id="qr-reader"></div>
                                    <div class="qr-overlay"></div>
                                </div>
                                
                                <div class="scanning-indicator">
                                    <div class="scanning-dot"></div>
                                    <div class="scanning-dot"></div>
                                    <div class="scanning-dot"></div>
                                </div>
                                
                                <p class="text-muted">QR 코드를 카메라에 비춰주세요</p>
                                
                                <button id="startScanBtn" class="btn btn-admin">
                                    <i class="fas fa-play me-2"></i>스캔 시작
                                </button>
                                
                                <button id="stopScanBtn" class="btn btn-outline-secondary" style="display: none;">
                                    <i class="fas fa-stop me-2"></i>스캔 중지
                                </button>
                            </div>

                            <!-- 사용자 정보 표시 -->
                            <div id="userInfoSection" class="user-info" style="display: none;">
                                <h5 class="mb-3">
                                    <i class="fas fa-user me-2"></i>참가자 정보
                                </h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>사번:</strong> <span id="employeeId"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>경품 번호:</strong> <span id="prizeNumber"></span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <strong>QR 생성 시간:</strong> <span id="qrTimestamp"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>유효성:</strong> <span id="qrValidity"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 상태 메시지 -->
                            <div id="statusMessage" class="status-message" style="display: none;">
                                <div id="statusText"></div>
                            </div>

                            <!-- 교환 처리 버튼 -->
                            <div id="exchangeSection" class="text-center" style="display: none;">
                                <button id="processExchangeBtn" class="btn btn-success-admin btn-lg" disabled>
                                    <i class="fas fa-check me-2"></i>경품 교환 처리
                                </button>
                                <button id="rejectBtn" class="btn btn-outline-danger btn-lg ms-3">
                                    <i class="fas fa-times me-2"></i>거부
                                </button>
                            </div>

                            <!-- 교환 완료 정보 -->
                            <div id="exchangeCompleteSection" class="user-info" style="display: none;">
                                <h5 class="mb-3 text-success">
                                    <i class="fas fa-check-circle me-2"></i>교환 완료
                                </h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>교환 ID:</strong> <span id="exchangeId"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>처리 시간:</strong> <span id="processTime"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="/js/main.js"></script>
    <script>
        let html5QrcodeScanner = null;
        let currentQRData = null;
        let adminToken = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializeAdminPage();
        });

        async function initializeAdminPage() {
            // 관리자 토큰 확인
            adminToken = localStorage.getItem('adminToken');
            if (!adminToken) {
                AIForum.showAlert('관리자 로그인이 필요합니다.', 'warning');
                setTimeout(() => {
                    window.location.href = '/app/admin/';
                }, 2000);
                return;
            }

            // QR 리더 초기화
            initializeQRReader();
        }

        function initializeQRReader() {
            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader",
                { 
                    fps: 10, 
                    qrbox: { width: 200, height: 200 },
                    aspectRatio: 1.0
                },
                false
            );

            // QR 코드 스캔 성공 콜백
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code scanned:', decodedText);
            
            try {
                const qrData = JSON.parse(decodedText);
                handleQRScan(qrData);
            } catch (error) {
                console.error('Invalid QR data:', error);
                showStatus('올바르지 않은 QR 코드입니다.', 'error');
            }
        }

        function onScanFailure(error) {
            // 스캔 실패는 정상적인 상황이므로 로그만 출력
            console.log('QR scan failed:', error);
        }

        async function handleQRScan(qrData) {
            currentQRData = qrData;
            
            // QR 리더 중지
            html5QrcodeScanner.clear();
            
            // UI 상태 변경
            document.getElementById('qrReaderSection').className = 'qr-reader-container active';
            document.getElementById('startScanBtn').style.display = 'none';
            document.getElementById('stopScanBtn').style.display = 'inline-block';
            
            // 로딩 상태 표시
            showStatus('QR 코드를 검증하는 중...', 'info');
            document.getElementById('userInfoSection').style.display = 'none';
            document.getElementById('exchangeSection').style.display = 'none';
            
            try {
                // 서버에서 교환 가능 여부 확인
                const response = await fetch('/api/prize/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ qrData: JSON.stringify(qrData) })
                });
                
                const result = await response.json();
                
                if (response.ok && result.exchangeable) {
                    // 교환 가능한 경우
                    displayUserInfo(qrData, result.user);
                    showStatus('교환이 가능합니다. 교환을 처리하세요.', 'success');
                    document.getElementById('exchangeSection').style.display = 'block';
                    document.getElementById('processExchangeBtn').disabled = false;
                } else {
                    // 교환 불가능한 경우
                    showStatus(result.error || '교환이 불가능합니다.', 'error');
                    document.getElementById('userInfoSection').style.display = 'none';
                    document.getElementById('exchangeSection').style.display = 'none';
                }
            } catch (error) {
                console.error('QR verification error:', error);
                showStatus('QR 코드 검증 중 오류가 발생했습니다.', 'error');
                document.getElementById('userInfoSection').style.display = 'none';
                document.getElementById('exchangeSection').style.display = 'none';
            }
        }

        function validateQRData(qrData) {
            // 필수 필드 확인
            const requiredFields = ['userId', 'employeeId', 'prizeNumber', 'prizeToken', 'timestamp', 'signature'];
            for (const field of requiredFields) {
                if (!qrData[field]) {
                    return { valid: false, message: 'QR 코드에 필수 정보가 누락되었습니다.' };
                }
            }

            // 시간 유효성 확인 (5분 이내)
            const now = Date.now();
            const qrTime = qrData.timestamp;
            if (now - qrTime > 5 * 60 * 1000) {
                return { valid: false, message: 'QR 코드가 만료되었습니다. (5분 초과)' };
            }

            return { valid: true };
        }

        function displayUserInfo(qrData, userInfo) {
            document.getElementById('employeeId').textContent = userInfo ? userInfo.employee_id : qrData.employeeId;
            document.getElementById('prizeNumber').textContent = qrData.prizeNumber;
            document.getElementById('qrTimestamp').textContent = new Date(qrData.timestamp).toLocaleString();
            
            const now = Date.now();
            const remaining = Math.max(0, 5 * 60 * 1000 - (now - qrData.timestamp));
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            if (remaining > 0) {
                document.getElementById('qrValidity').innerHTML = `<span class="text-success">유효 (${minutes}:${seconds.toString().padStart(2, '0')} 남음)</span>`;
            } else {
                document.getElementById('qrValidity').innerHTML = '<span class="text-danger">만료됨</span>';
            }
            
            document.getElementById('userInfoSection').style.display = 'block';
        }

        async function processExchange() {
            if (!currentQRData) {
                AIForum.showAlert('처리할 QR 데이터가 없습니다.', 'warning');
                return;
            }

            const processBtn = document.getElementById('processExchangeBtn');
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>처리 중...';

            try {
                const response = await fetch('/api/prize/verify-and-exchange', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        qrData: JSON.stringify(currentQRData)
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // 교환 완료 처리
                    document.getElementById('exchangeCompleteSection').style.display = 'block';
                    document.getElementById('exchangeId').textContent = data.exchangeId;
                    document.getElementById('processTime').textContent = new Date().toLocaleString();
                    
                    document.getElementById('exchangeSection').style.display = 'none';
                    document.getElementById('qrReaderSection').className = 'qr-reader-container success';
                    
                    showStatus('경품 교환이 완료되었습니다.', 'success');
                    AIForum.showAlert('경품 교환이 성공적으로 처리되었습니다.', 'success');
                } else {
                    showStatus(data.error || '교환 처리에 실패했습니다.', 'error');
                    AIForum.showAlert(data.error || '교환 처리에 실패했습니다.', 'danger');
                }
            } catch (error) {
                console.error('Exchange processing error:', error);
                showStatus('교환 처리 중 오류가 발생했습니다.', 'error');
                AIForum.showAlert('교환 처리 중 오류가 발생했습니다.', 'danger');
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-check me-2"></i>경품 교환 처리';
            }
        }

        function rejectExchange() {
            if (confirm('이 경품 교환을 거부하시겠습니까?')) {
                showStatus('경품 교환이 거부되었습니다.', 'error');
                resetScanner();
            }
        }

        function resetScanner() {
            currentQRData = null;
            
            // UI 초기화
            document.getElementById('qrReaderSection').className = 'qr-reader-container';
            document.getElementById('userInfoSection').style.display = 'none';
            document.getElementById('exchangeSection').style.display = 'none';
            document.getElementById('exchangeCompleteSection').style.display = 'none';
            document.getElementById('statusMessage').style.display = 'none';
            
            document.getElementById('startScanBtn').style.display = 'inline-block';
            document.getElementById('stopScanBtn').style.display = 'none';
            
            // QR 리더 재시작
            initializeQRReader();
        }

        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            
            statusMessage.className = `status-message status-${type}`;
            statusText.textContent = message;
            statusMessage.style.display = 'block';
        }

        function logout() {
            if (confirm('로그아웃하시겠습니까?')) {
                localStorage.removeItem('adminToken');
                window.location.href = '/app/admin/';
            }
        }

        // 이벤트 리스너
        document.getElementById('startScanBtn').addEventListener('click', () => {
            document.getElementById('startScanBtn').style.display = 'none';
            document.getElementById('stopScanBtn').style.display = 'inline-block';
            initializeQRReader();
        });

        document.getElementById('stopScanBtn').addEventListener('click', resetScanner);
        document.getElementById('processExchangeBtn').addEventListener('click', processExchange);
        document.getElementById('rejectBtn').addEventListener('click', rejectExchange);

        // 페이지 언로드 시 QR 리더 정리
        window.addEventListener('beforeunload', () => {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }
        });
    </script>
</body>
</html>
