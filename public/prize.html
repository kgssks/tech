<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>경품 수령 - AI 기술테크포럼 2024</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .prize-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--kb-background) 0%, #f0f0f0 100%);
        }
        
        .prize-card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--kb-shadow);
            background: white;
        }
        
        .prize-header {
            background: linear-gradient(135deg, var(--kb-yellow-positive) 0%, var(--kb-yellow-negative) 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 2rem;
            text-align: center;
        }
        
        .qr-container {
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 1rem 0;
        }
        
        .qr-code {
            max-width: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .status-indicator {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
        }
        
        .status-waiting {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1976d2;
            border: 2px solid #2196f3;
        }
        
        .status-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #2e7d32;
            border: 2px solid #4caf50;
        }
        
        .status-error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
            border: 2px solid #f44336;
        }
        
        .prize-info {
            background: var(--kb-background);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .countdown {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--kb-yellow-positive);
        }
        
        .btn-prize {
            background: linear-gradient(135deg, var(--kb-yellow-positive) 0%, var(--kb-yellow-negative) 100%);
            border: none;
            color: white;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 25px;
            box-shadow: 0 5px 15px rgba(255, 188, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-prize:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 188, 0, 0.4);
            color: white;
        }
        
        .btn-prize:disabled {
            background: #ccc;
            box-shadow: none;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="prize-container">
        <!-- 네비게이션 -->
        <nav class="navbar navbar-expand-lg navbar-dark" style="background: var(--kb-gray);">
            <div class="container">
                <a class="navbar-brand fw-bold" href="/">
                    <i class="fas fa-gift me-2"></i>AI Tech Forum 2024
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/app/event/data">
                        <i class="fas fa-chart-line me-1"></i>이벤트 현황
                    </a>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card prize-card">
                        <div class="prize-header">
                            <h2 class="mb-3">
                                <i class="fas fa-gift me-2"></i>경품 수령
                            </h2>
                            <p class="mb-0">경품 자격을 확인하고 QR 코드를 생성하세요</p>
                        </div>
                        
                        <div class="card-body p-4">
                            <!-- 경품 자격 확인 -->
                            <div id="eligibilityCheck" class="prize-info">
                                <h5 class="mb-3">
                                    <i class="fas fa-check-circle me-2"></i>경품 자격 확인
                                </h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-door-open"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">입장 확인</div>
                                                <div id="entryStatus" class="text-muted">확인 중...</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-store"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">부스 참여</div>
                                                <div id="boothStatus" class="text-muted">확인 중...</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                <i class="fas fa-poll"></i>
                                            </div>
                                            <div>
                                                <div class="fw-bold">설문 참여</div>
                                                <div id="surveyStatus" class="text-muted">확인 중...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- QR 코드 생성 버튼 -->
                            <div id="qrGenerationSection" class="text-center" style="display: none;">
                                <button id="generateQRBtn" class="btn btn-prize btn-lg">
                                    <i class="fas fa-qrcode me-2"></i>경품 QR 코드 생성
                                </button>
                            </div>

                            <!-- QR 코드 표시 -->
                            <div id="qrDisplaySection" class="qr-container" style="display: none;">
                                <h5 class="mb-3">
                                    <i class="fas fa-qrcode me-2"></i>경품 수령 QR 코드
                                </h5>
                                <img id="qrCodeImage" class="qr-code" alt="QR Code">
                                <div class="mt-3">
                                    <div class="countdown" id="countdown">유효시간: 5:00</div>
                                    <p class="text-muted mt-2">관리자에게 이 QR 코드를 보여주세요</p>
                                </div>
                            </div>

                            <!-- 상태 표시 -->
                            <div id="statusSection" class="status-indicator" style="display: none;">
                                <div id="statusIcon"></div>
                                <div id="statusMessage"></div>
                            </div>

                            <!-- 경품 정보 -->
                            <div id="prizeInfo" class="prize-info" style="display: none;">
                                <h5 class="mb-3">
                                    <i class="fas fa-trophy me-2"></i>경품 정보
                                </h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>경품 번호:</strong> <span id="prizeNumber"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>교환 시간:</strong> <span id="exchangeTime"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/main.js"></script>
    <script>
        let socket = null;
        let countdownInterval = null;
        let qrExpiryTime = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializePrizePage();
        });

        async function initializePrizePage() {
            // 토큰 확인
            const token = AIForum.StorageManager.getToken();
            if (!token || !AIForum.StorageManager.isTokenValid()) {
                AIForum.showAlert('로그인이 필요합니다.', 'warning');
                setTimeout(() => {
                    window.location.href = '/app/event/auth';
                }, 2000);
                return;
            }

            // Socket.IO 연결
            socket = io();
            
            socket.on('connect', () => {
                console.log('Socket.IO connected with ID:', socket.id);
            });

            socket.on('disconnect', () => {
                console.log('Socket.IO disconnected');
            });

            // 경품 교환 결과 수신
            socket.on('prize-exchange-result', (data) => {
                console.log('Received prize exchange result:', data);
                handlePrizeExchangeResult(data);
            });

            // 경품 자격 확인
            await checkPrizeEligibility();
        }

        async function checkPrizeEligibility() {
            try {
                const response = await AIForum.ApiClient.get('/api/event/status');
                
                if (response.ok) {
                    const data = await response.json();
                    updateEligibilityStatus(data);
                    
                    if (data.prize_eligible) {
                        document.getElementById('qrGenerationSection').style.display = 'block';
                    } else {
                        AIForum.showAlert('경품 수령 자격이 없습니다. 모든 조건을 만족해주세요.', 'warning');
                    }
                } else {
                    AIForum.showAlert('경품 자격 확인에 실패했습니다.', 'danger');
                }
            } catch (error) {
                console.error('Prize eligibility check error:', error);
                AIForum.showAlert('경품 자격 확인 중 오류가 발생했습니다.', 'danger');
            }
        }

        function updateEligibilityStatus(data) {
            // 입장 확인 상태
            const entryStatus = document.getElementById('entryStatus');
            if (data.entry_confirmed) {
                entryStatus.innerHTML = '<i class="fas fa-check text-success me-1"></i>완료';
            } else {
                entryStatus.innerHTML = '<i class="fas fa-times text-danger me-1"></i>미완료';
            }

            // 부스 참여 상태
            const boothStatus = document.getElementById('boothStatus');
            const boothCount = (data.booth_1 ? 1 : 0) + (data.booth_2 ? 1 : 0) + (data.booth_3 ? 1 : 0) + (data.booth_4 ? 1 : 0) + (data.booth_5 ? 1 : 0);
            boothStatus.innerHTML = `${boothCount}/3개 부스`;
            if (boothCount >= 3) {
                boothStatus.innerHTML = '<i class="fas fa-check text-success me-1"></i>' + boothStatus.innerHTML;
            } else {
                boothStatus.innerHTML = '<i class="fas fa-times text-danger me-1"></i>' + boothStatus.innerHTML;
            }

            // 설문 참여 상태
            const surveyStatus = document.getElementById('surveyStatus');
            if (data.survey_participated) {
                surveyStatus.innerHTML = '<i class="fas fa-check text-success me-1"></i>완료';
            } else {
                surveyStatus.innerHTML = '<i class="fas fa-times text-danger me-1"></i>미완료';
            }
        }

        async function generatePrizeQR() {
            const generateBtn = document.getElementById('generateQRBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>생성 중...';

            try {
                const response = await AIForum.ApiClient.post('/api/prize/generate-qr');
                
                if (response.ok) {
                    const data = await response.json();
                    displayQRCode(data);
                    startCountdown();
                    
                    // QR 데이터에서 userId 추출
                    const qrData = JSON.parse(data.data);
                    
                    // Socket.IO 대기방 입장
                    console.log('Joining prize waiting room:', {
                        userId: qrData.userId,
                        prizeToken: data.prizeToken
                    });
                    
                    socket.emit('join-prize-waiting', {
                        userId: qrData.userId,
                        prizeToken: data.prizeToken
                    });
                    
                    AIForum.showAlert('경품 QR 코드가 생성되었습니다.', 'success');
                } else {
                    const errorData = await response.json();
                    AIForum.showAlert(errorData.error || 'QR 코드 생성에 실패했습니다.', 'danger');
                }
            } catch (error) {
                console.error('QR generation error:', error);
                AIForum.showAlert('QR 코드 생성 중 오류가 발생했습니다.', 'danger');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-qrcode me-2"></i>경품 QR 코드 생성';
            }
        }

        function displayQRCode(data) {
            document.getElementById('qrCodeImage').src = data.qr_code;
            document.getElementById('qrDisplaySection').style.display = 'block';
            document.getElementById('qrGenerationSection').style.display = 'none';
            
            // 경품 번호 표시
            document.getElementById('prizeNumber').textContent = data.prizeNumber;
            document.getElementById('prizeInfo').style.display = 'block';
        }

        function startCountdown() {
            qrExpiryTime = Date.now() + (5 * 60 * 1000); // 5분
            
            countdownInterval = setInterval(() => {
                const now = Date.now();
                const remaining = qrExpiryTime - now;
                
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown').textContent = '만료됨';
                    document.getElementById('qrDisplaySection').style.display = 'none';
                    document.getElementById('qrGenerationSection').style.display = 'block';
                    AIForum.showAlert('QR 코드가 만료되었습니다. 다시 생성해주세요.', 'warning');
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('countdown').textContent = `유효시간: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function handlePrizeExchangeResult(data) {
            clearInterval(countdownInterval);
            
            const statusSection = document.getElementById('statusSection');
            const statusIcon = document.getElementById('statusIcon');
            const statusMessage = document.getElementById('statusMessage');
            
            statusSection.style.display = 'block';
            
            if (data.success) {
                statusSection.className = 'status-indicator status-success';
                statusIcon.innerHTML = '<i class="fas fa-check-circle fa-3x mb-3"></i>';
                statusMessage.innerHTML = `
                    <h4>경품 교환 완료!</h4>
                    <p>경품 번호: <strong>${data.prizeNumber}</strong></p>
                    <p>교환 시간: <strong>${new Date(data.timestamp).toLocaleString()}</strong></p>
                `;
                
                document.getElementById('exchangeTime').textContent = new Date(data.timestamp).toLocaleString();
                document.getElementById('qrDisplaySection').style.display = 'none';
                
                AIForum.showAlert('경품 교환이 완료되었습니다!', 'success');
            } else {
                statusSection.className = 'status-indicator status-error';
                statusIcon.innerHTML = '<i class="fas fa-times-circle fa-3x mb-3"></i>';
                statusMessage.innerHTML = `
                    <h4>교환 실패</h4>
                    <p>${data.message || '경품 교환에 실패했습니다.'}</p>
                `;
                
                AIForum.showAlert(data.message || '경품 교환에 실패했습니다.', 'danger');
            }
        }

        // QR 생성 버튼 이벤트
        document.getElementById('generateQRBtn').addEventListener('click', generatePrizeQR);

        // 페이지 언로드 시 Socket.IO 연결 해제
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
